# 3. Процесс работы с ветками

## 3.1. Структура ветвления (GitFlow)

Основные ветки репозитория:

- `main` (или `master`) — стабильная продуктивная версия. Прямые коммиты запрещены, изменения поступают только через `release/` или `hotfix/`.
- `develop` — основная ветка разработки. Содержит актуальный код, готовый к тестированию.
- `feature/*` — ветки для разработки нового функционала.
- `bugfix/*` — ветки для исправлений до релиза.
- `release/*` — ветки подготовки релиза.
- `hotfix/*` — ветки экстренных исправлений продуктивной версии.

## 3.2. Создание веток

**Новая функциональность**

```bash
git checkout develop
git checkout -b feature/<имя_функции>
```

**Исправление ошибок**

```bash
git checkout develop
git checkout -b bugfix/<номер_тикета>
```

**Подготовка релиза**

```bash
git checkout develop
git checkout -b release/<версия>
```

**Горячее исправление (hotfix)**

```bash
git checkout main
git checkout -b hotfix/<номер_тикета>
```

## 3.3. Правила оформления коммит-сообщений

Корректное оформление коммитов — ключ к читаемой истории изменений, упрощению ревью и автоматизации сборок. Коммит должен отражать одну законченную задачу, быть понятен без просмотра диффа и соответствовать приведённым ниже требованиям.

**Общие правила**

1. Каждый коммит должен быть атомарным — содержать одно логически завершённое изменение (например, добавление функции, исправление бага или обновление документации).
2. Перед фиксацией изменений необходимо убедиться, что код компилируется, проходит тесты и не содержит временных правок.
3. Коммит оформляется в виде структурированного сообщения, состоящего из заголовка, тела и, при необходимости, нижней части с дополнительной информацией.
4. Используется повелительное наклонение (например: Add, Fix, Update, Remove).
5. Заголовок должен быть кратким (до 50 символов) и понятным — он отображается в логах и при ревью.
6. Между заголовком и телом обязательно вставляется пустая строка.
7. Тело коммита (если используется) должно отвечать на вопросы что сделано и зачем, но не как.
8. Если коммит связан с задачей или MR, добавляется ссылка в конце тела, например: `Related to: #1245` или `Fixes: MR!37`.

**Шаблон коммит-сообщения**

```
<Тип изменения>: <краткое описание>

<Подробное описание изменения, при необходимости>

Refs: #<номер задачи> / MR!<номер>
```

**Типы изменений (рекомендуемые префиксы)**

- `feat:` — добавление нового функционала.
- `fix:` — исправление ошибки.
- `refactor:` — изменение структуры кода без изменения логики.
- `docs:` — изменение документации.
- `test:` — добавление или изменение тестов.
- `build:` — изменения, связанные со сборкой, CI/CD.
- `chore:` — технические правки (обновление зависимостей, форматирование и т.п.).

**Пример правильного коммита**

```
fix: корректна проверка токена при продлении сессии

Исправлена логика обновления токена доступа. Теперь при повторной аутентификации
сессия корректно продлевается без повторного входа пользователя.
Fixes: #512
```

Хорошо, потому что:

- короткий, осмысленный заголовок в повелительном наклонении;
- есть тело, объясняющее суть и причину;
- указана связь с задачей в трекере;
- структура выдержана (заголовок, пустая строка, тело, ссылка).

**Пример неправильного коммита**

```
исправил немного авторизацию и кое-что еще
```

Плохо, потому что:

- нет типа (`fix:` / `feat:` и др.);
- отсутствует описание сути и причины изменений;
- неясно, что именно исправлено;
- используется разговорный стиль;
- не указан номер задачи.

## 3.4. Merge Request (MR)

- MR создаётся только через GitLab.
- В MR указываются:
  - ссылка на задачу в трекере;
  - описание изменений и результаты тестирования;
  - отметки согласующих лиц (архитектор, QA, релиз-менеджер).
- Все pipeline-проверки должны пройти успешно.
- После ревью MR сливается в `develop` (тип слияния — merge commit или squash по решению релиз-менеджера).

## 3.5. Комментарии в коде

Цель — сделать поведение системы и принятые решения понятными без “археологии” по коммитам и задачам, сократить время ревью и сопровождения.

### 3.5.1. Общие принципы

- **Единый язык.** Комментарии пишем по-русски. Английский допустим в публичных API/библиотеках (по решению релиз-менеджера или архитектора).
- **Объясняем «почему», а не «что».** Очевидное из кода не дублируем; комментируем нетривиальные решения, ограничения и допущения.
- **Актуальность.** Комментарии обновляются вместе с кодом; в MR проверяется соответствие фактическому поведению.
- **Локальность.** Комментарий располагается максимально близко к месту, которого он касается.
- **Конфиденциальность.** Запрещено раскрывать секреты, ключи, пароли, внутренние URL и персональные данные.

### 3.5.2. Когда комментировать

- нетривиальные алгоритмы, оптимизации, workaround’ы (почему выбрано именно так);
- бизнес-правила и их источники (ссылка на задачу или требование);
- неочевидные зависимости, побочные эффекты, ограничения производительности;
- публичные интерфейсы: назначение, параметры, возвращаемые значения, исключения.

### 3.5.3. Форматы и теги

- **Обычные комментарии** (`//`, `#`, `/* … */`) — кратко и по делу (1–3 строки).
- **Док-комментарии** (docstring, JSDoc, XMLDoc) описывают назначение, параметры, возвращаемые значения, исключения и побочные эффекты.
- **Статус-теги** (заглавными):
  - `TODO(#123)` — задача известна, доработать позже (ссылка на issue/MR обязательна).
  - `FIXME(#123)` — есть ошибка или технический долг, требуется исправление.
  - `HACK` — временное решение с обязательным обоснованием.
  - `DEPRECATED` — не использовать в новом коде, указать альтернативу и срок удаления.
  - `NOTE` — важное пояснение или контекст.

Формат: `TAG(ссылка/контекст, дедлайн при наличии): краткое пояснение`.

Пример: `TODO(#482, до 2025-11-15): вынести в конфиг и покрыть тестами`.

### 3.5.4. Шаблоны док-комментариев

**Python**

```python
def renew_token(user_id: int) -> str:
    """
    Обновляет токен доступа пользователя.

    Args:
        user_id: Идентификатор пользователя.

    Returns:
        Новый JWT-токен.

    Raises:
        AuthError: Если пользователь заблокирован или токен истёк некорректно.

    Note:
        Производит запись в аудит. См. задачу #512.
    """
```

**TypeScript / JSDoc**

```typescript
/**
 * Продляет сессию пользователя на заданный срок.
 * @param userId Идентификатор пользователя.
 * @param ttlMs Время жизни в миллисекундах.
 * @returns Новый accessToken.
 * @throws AuthError Если пользователь не авторизован.
 * @note См. MR!37: изменён формат payload.
 */
```

### 3.5.5. Хорошо / Плохо

**Хороший комментарий**

```ts
// Почему: внешний сервис иногда возвращает 409 при идемпотентных повторах.
// Решение: делаем экспоненциальный бэкофф до 3 попыток (см. #731).
const MAX_RETRIES = 3;
```

**Плохой комментарий**

```ts
// Увеличил ретраи
const MAX_RETRIES = 3; // комментарий дублирует код и не добавляет смысла
```

### 3.5.6. Проверка на ревью и в MR

- Наличие и уместность комментариев к сложным участкам.
- Актуальность: комментарии не противоречат фактическому поведению.
- Теги `TODO`/`FIXME` содержат ссылки на задачи и (при необходимости) дедлайны.
- Комментарии не содержат секретов и персональных данных.
